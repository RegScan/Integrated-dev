# 内容合规检测系统 - 模块化开发方案

## 项目概述

基于现有技术规划，将内容合规检测系统按照功能职责和技术边界进行模块化拆分，确保各模块独立开发、测试和部署，提高开发效率和系统可维护性。

## 模块架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        前端展示层                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   Web管理后台   │  │   数据可视化    │  │   移动端应用    │  │
│  │   (Vue.js)      │  │   (Grafana)     │  │   (可选)        │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────▼───────────────────────────────┐
│                        API网关层                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   路由转发      │  │   认证授权      │  │   限流熔断      │  │
│  │   (Nginx)       │  │   (JWT)         │  │   (Redis)       │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────▼───────────────────────────────┐
│                        核心业务层                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   网站检测模块  │  │   流量分析模块  │  │   告警处置模块  │  │
│  │   (FastAPI)     │  │   (Suricata)    │  │   (FastAPI)     │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   任务调度模块  │  │   配置管理模块  │  │   报表统计模块  │  │
│  │   (Celery)      │  │   (FastAPI)     │  │   (FastAPI)     │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────▼───────────────────────────────┐
│                        数据存储层                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   MongoDB       │  │   Redis         │  │   Elasticsearch │  │
│  │   (业务数据)    │  │   (缓存/队列)   │  │   (日志检索)    │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 核心模块详细设计

### 1. 网站检测模块 (website-scanner)

**功能职责：**
- 网站内容爬取
- 文本/图片合规检测
- 备案信息查询
- 检测结果存储

**技术栈：**
- FastAPI (Web框架)
- Scrapy + Playwright (爬虫)
- Requests (HTTP客户端)
- PyMongo (MongoDB驱动)

**目录结构：**
```
website-scanner/
├── app/
│   ├── __init__.py
│   ├── main.py                 # FastAPI应用入口
│   ├── models/
│   │   ├── __init__.py
│   │   ├── website.py          # 网站数据模型
│   │   └── scan_result.py      # 检测结果模型
│   ├── services/
│   │   ├── __init__.py
│   │   ├── crawler.py          # 爬虫服务
│   │   ├── content_checker.py  # 内容检测服务
│   │   └── beian_checker.py    # 备案查询服务
│   ├── api/
│   │   ├── __init__.py
│   │   ├── scan.py             # 扫描API
│   │   └── results.py          # 结果查询API
│   └── utils/
│       ├── __init__.py
│       ├── database.py         # 数据库连接
│       └── config.py           # 配置管理
├── tests/
├── requirements.txt
└── Dockerfile
```

**开发优先级：** 高（核心功能）
**预估工期：** 3-4周

### 2. 流量分析模块 (traffic-analyzer)

**功能职责：**
- 网络流量镜像接收
- 流量特征分析
- 异常行为检测
- 实时告警触发

**技术栈：**
- Suricata (IDS引擎)
- Python (规则管理)
- nDPI (协议识别)
- FastAPI (管理接口)

**目录结构：**
```
traffic-analyzer/
├── suricata/
│   ├── suricata.yaml           # Suricata配置
│   ├── rules/
│   │   ├── compliance.rules    # 合规检测规则
│   │   ├── ddos.rules          # DDoS检测规则
│   │   └── vpn.rules           # VPN检测规则
│   └── logs/
├── app/
│   ├── __init__.py
│   ├── main.py                 # 管理API入口
│   ├── services/
│   │   ├── __init__.py
│   │   ├── rule_manager.py     # 规则管理
│   │   ├── log_parser.py       # 日志解析
│   │   └── alert_processor.py  # 告警处理
│   └── models/
│       ├── __init__.py
│       └── traffic_event.py    # 流量事件模型
├── scripts/
│   ├── install_suricata.sh     # 安装脚本
│   └── update_rules.py         # 规则更新脚本
├── tests/
├── requirements.txt
└── docker-compose.yml
```

**开发优先级：** 中（第二阶段）
**预估工期：** 4-5周

### 3. 告警处置模块 (alert-handler)

**功能职责：**
- 告警事件接收
- 告警级别判定
- 多渠道通知发送
- 自动处置执行
- 工单系统集成

**技术栈：**
- FastAPI (Web框架)
- Celery (异步任务)
- SMTP/SMS (通知渠道)
- Requests (外部API调用)

**目录结构：**
```
alert-handler/
├── app/
│   ├── __init__.py
│   ├── main.py                 # FastAPI应用入口
│   ├── models/
│   │   ├── __init__.py
│   │   ├── alert.py            # 告警模型
│   │   └── action.py           # 处置动作模型
│   ├── services/
│   │   ├── __init__.py
│   │   ├── alert_processor.py  # 告警处理服务
│   │   ├── notification.py     # 通知服务
│   │   ├── auto_action.py      # 自动处置服务
│   │   └── ticket_system.py    # 工单系统集成
│   ├── api/
│   │   ├── __init__.py
│   │   ├── alerts.py           # 告警API
│   │   └── actions.py          # 处置API
│   └── tasks/
│       ├── __init__.py
│       ├── email_tasks.py      # 邮件任务
│       ├── sms_tasks.py        # 短信任务
│       └── action_tasks.py     # 处置任务
├── templates/
│   ├── email_alert.html        # 邮件模板
│   └── sms_alert.txt           # 短信模板
├── tests/
├── requirements.txt
└── Dockerfile
```

**开发优先级：** 高（核心功能）
**预估工期：** 2-3周

### 4. 任务调度模块 (task-scheduler)

**功能职责：**
- 定时任务管理
- 分布式任务调度
- 任务状态监控
- 失败重试机制

**技术栈：**
- Celery (任务队列)
- RabbitMQ (消息代理)
- Redis (结果存储)
- Flower (监控界面)

**目录结构：**
```
task-scheduler/
├── app/
│   ├── __init__.py
│   ├── celery_app.py           # Celery应用配置
│   ├── tasks/
│   │   ├── __init__.py
│   │   ├── scan_tasks.py       # 扫描任务
│   │   ├── report_tasks.py     # 报表任务
│   │   └── cleanup_tasks.py    # 清理任务
│   ├── schedules/
│   │   ├── __init__.py
│   │   └── periodic_tasks.py   # 周期性任务配置
│   └── utils/
│       ├── __init__.py
│       └── task_utils.py       # 任务工具函数
├── config/
│   ├── celery_config.py        # Celery配置
│   └── rabbitmq_config.py      # RabbitMQ配置
├── scripts/
│   ├── start_worker.sh         # 启动Worker脚本
│   └── start_beat.sh           # 启动Beat脚本
├── tests/
├── requirements.txt
└── docker-compose.yml
```

**开发优先级：** 中（支撑功能）
**预估工期：** 2周

### 5. 配置管理模块 (config-manager)

**功能职责：**
- 系统配置管理
- 检测规则配置
- 用户权限管理
- 系统参数调优

**技术栈：**
- FastAPI (Web框架)
- Pydantic (配置验证)
- PyYAML (配置文件)
- SQLAlchemy (用户管理)

**目录结构：**
```
config-manager/
├── app/
│   ├── __init__.py
│   ├── main.py                 # FastAPI应用入口
│   ├── models/
│   │   ├── __init__.py
│   │   ├── config.py           # 配置模型
│   │   └── user.py             # 用户模型
│   ├── services/
│   │   ├── __init__.py
│   │   ├── config_service.py   # 配置服务
│   │   └── user_service.py     # 用户服务
│   ├── api/
│   │   ├── __init__.py
│   │   ├── config.py           # 配置API
│   │   ├── users.py            # 用户API
│   │   └── auth.py             # 认证API
│   └── schemas/
│       ├── __init__.py
│       ├── config_schema.py    # 配置Schema
│       └── user_schema.py      # 用户Schema
├── configs/
│   ├── default.yaml            # 默认配置
│   ├── production.yaml         # 生产环境配置
│   └── development.yaml        # 开发环境配置
├── tests/
├── requirements.txt
└── Dockerfile
```

**开发优先级：** 中（支撑功能）
**预估工期：** 2-3周

### 6. 报表统计模块 (report-generator)

**功能职责：**
- 检测数据统计
- 报表生成
- 趋势分析
- 数据导出

**技术栈：**
- FastAPI (Web框架)
- Pandas (数据处理)
- Matplotlib/Plotly (图表生成)
- ReportLab (PDF生成)

**目录结构：**
```
report-generator/
├── app/
│   ├── __init__.py
│   ├── main.py                 # FastAPI应用入口
│   ├── services/
│   │   ├── __init__.py
│   │   ├── data_aggregator.py  # 数据聚合服务
│   │   ├── chart_generator.py  # 图表生成服务
│   │   └── report_builder.py   # 报表构建服务
│   ├── api/
│   │   ├── __init__.py
│   │   ├── reports.py          # 报表API
│   │   └── statistics.py       # 统计API
│   └── templates/
│       ├── daily_report.html   # 日报模板
│       ├── weekly_report.html  # 周报模板
│       └── monthly_report.html # 月报模板
├── static/
│   ├── css/
│   ├── js/
│   └── images/
├── tests/
├── requirements.txt
└── Dockerfile
```

**开发优先级：** 低（第三阶段）
**预估工期：** 3-4周

### 7. Web管理后台 (web-admin)

**功能职责：**
- 系统管理界面
- 检测任务管理
- 告警事件查看
- 配置参数设置
- 用户权限管理

**技术栈：**
- Vue.js 3 (前端框架)
- Element Plus (UI组件库)
- Axios (HTTP客户端)
- Echarts (图表库)

**目录结构：**
```
web-admin/
├── src/
│   ├── main.js                 # 应用入口
│   ├── App.vue                 # 根组件
│   ├── router/
│   │   └── index.js            # 路由配置
│   ├── store/
│   │   └── index.js            # 状态管理
│   ├── views/
│   │   ├── Dashboard.vue       # 仪表盘
│   │   ├── ScanManagement.vue  # 扫描管理
│   │   ├── AlertCenter.vue     # 告警中心
│   │   ├── ConfigCenter.vue    # 配置中心
│   │   └── UserManagement.vue  # 用户管理
│   ├── components/
│   │   ├── common/             # 通用组件
│   │   ├── charts/             # 图表组件
│   │   └── forms/              # 表单组件
│   ├── api/
│   │   ├── scan.js             # 扫描API
│   │   ├── alert.js            # 告警API
│   │   ├── config.js           # 配置API
│   │   └── user.js             # 用户API
│   └── utils/
│       ├── request.js          # HTTP请求封装
│       └── auth.js             # 认证工具
├── public/
├── tests/
├── package.json
├── vite.config.js
└── Dockerfile
```

**开发优先级：** 中（用户界面）
**预估工期：** 4-5周

## 开发计划与里程碑

### 第一阶段：核心功能开发（1-2个月）

**目标：** 实现基础的网站合规检测和告警功能

**开发顺序：**
1. 配置管理模块（基础设施）
2. 网站检测模块（核心功能）
3. 告警处置模块（核心功能）
4. 任务调度模块（支撑功能）
5. Web管理后台（基础界面）

**里程碑：**
- [ ] 完成单域名网站内容检测
- [ ] 实现邮件/短信告警通知
- [ ] 提供基础的Web管理界面
- [ ] 支持定时批量扫描任务

### 第二阶段：功能增强（2-4个月）

**目标：** 增加流量分析和高级检测能力

**开发顺序：**
1. 流量分析模块（新增功能）
2. 网站检测模块增强（子域名扫描、深度爬取）
3. 告警处置模块增强（自动处置、工单集成）
4. Web管理后台增强（流量监控界面）

**里程碑：**
- [ ] 完成网络流量实时分析
- [ ] 支持自动化处置违规服务器
- [ ] 实现子域名递归扫描
- [ ] 提供流量监控可视化界面

### 第三阶段：系统优化（4-6个月）

**目标：** 提升系统性能和用户体验

**开发顺序：**
1. 报表统计模块（数据分析）
2. 系统性能优化（分布式部署）
3. 监控告警完善（系统监控）
4. 用户体验优化（界面美化）

**里程碑：**
- [ ] 完成数据报表和趋势分析
- [ ] 支持分布式集群部署
- [ ] 实现系统性能监控
- [ ] 提供移动端管理应用

## 技术规范与约定

### 代码规范
- Python代码遵循PEP 8规范
- JavaScript代码遵循ESLint标准
- 所有模块必须包含单元测试
- API接口遵循RESTful设计原则

### 数据库设计
- MongoDB用于存储非结构化检测数据
- Redis用于缓存和任务队列
- Elasticsearch用于日志检索和分析

### 接口设计
- 统一使用JSON格式进行数据交换
- API版本控制采用URL路径方式（/api/v1/）
- 错误响应遵循统一的错误码规范

### 部署规范
- 所有模块支持Docker容器化部署
- 使用docker-compose进行本地开发环境搭建
- 生产环境支持Kubernetes集群部署

## 风险评估与应对

### 技术风险
1. **第三方API限制**
   - 风险：内容审核API调用频率限制
   - 应对：实现API轮询机制，支持多厂商API

2. **流量分析性能**
   - 风险：大流量环境下Suricata性能瓶颈
   - 应对：采用流量采样，部署多节点分析集群

3. **数据存储压力**
   - 风险：大量检测数据导致存储压力
   - 应对：实现数据分层存储，定期清理历史数据

### 业务风险
1. **误报率控制**
   - 风险：检测规则过于严格导致误报
   - 应对：建立白名单机制，支持人工审核

2. **合规性要求**
   - 风险：数据处理不符合法规要求
   - 应对：最小化数据收集，加强访问控制

## 总结

通过模块化设计，将复杂的内容合规检测系统拆分为7个独立的功能模块，每个模块职责清晰、边界明确。采用分阶段迭代开发的方式，优先实现核心功能，逐步完善系统能力。这种设计方案具有以下优势：

1. **开发效率高**：模块间解耦，支持并行开发
2. **可维护性强**：单一职责原则，便于问题定位和修复
3. **扩展性好**：模块化架构，便于功能扩展和性能优化
4. **部署灵活**：支持单体和分布式两种部署模式
5. **技术风险低**：采用成熟的开源技术栈，降低技术风险

建议按照本方案进行开发，确保项目按时交付并满足业务需求。